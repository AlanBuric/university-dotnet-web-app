@page "/"
@inject HttpClient Http
@rendermode @(new InteractiveWebAssemblyRenderMode(false))

<PageTitle>Kolegiji</PageTitle>

<h2>Kolegiji</h2>

<p>Niže je naveden popis kolegija na Sveučilištu.</p>

@if (subjects == null)
{
	<p><em>Učitavam...</em></p>
}
else
{
	<h4>@(isEditing ? "Uređivanje kolegija" : "Dodavanje novog kolegija")</h4>

	@if (!string.IsNullOrEmpty(apiError))
	{
		<div class="alert alert-danger" role="alert">
			@apiError
		</div>
	}

	<EditForm Model="currentSubject" OnValidSubmit="HandleValidSubmit" FormName="SubjectForm">
		<DataAnnotationsValidator />
		<ValidationSummary />

		<div class="mb-3">
			<label for="Name" class="form-label">Naziv</label>
			<InputText id="Name" class="form-control" @bind-Value="currentSubject.Name" />
		</div>

		<button type="submit" class="btn btn-success">
			@(isEditing ? "Spremi promjene" : "Dodaj kolegij")
		</button>
		@if (isEditing)
		{
			<button type="button" class="btn btn-secondary ms-2" @onclick="CancelEdit">Odustani</button>
		}
	</EditForm>

	<hr />

	@if (subjects.Length > 0)
	{
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Naziv</th>
					<th>Radnje</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var subject in subjects)
				{
					<tr>
						<td>@subject.Id</td>
						<td>@subject.Name</td>
						<td>
							<button class="btn btn-primary btn-sm" @onclick="() => EditSubject(subject)">Uredi</button>
							<button class="btn btn-danger btn-sm" @onclick="() => DeleteSubject(subject)">Obriši</button>
						</td>
					</tr>
				}
			</tbody>
		</table>
	}
	else
	{
		<p class="text-center">Sveučilište trenutno nema unesenih kolegija.</p>
	}
}

@code {
	private Subject[]? subjects;

	private Subject currentSubject { get; set; } = new Subject();

	private bool isEditing = false;

	private string? apiError;

	protected override async Task OnInitializedAsync()
	{
		currentSubject = new Subject();
		await LoadSubjects();
	}

	private async Task LoadSubjects()
	{
		apiError = null;

		try
		{
			subjects = await Http.GetFromJsonAsync<Subject[]>("api/subject");
		}
		catch (Exception ex)
		{
			apiError = $"Došlo je do pogreške pri učitavanju kolegija: {ex.Message}";
		}
	}

	private async Task HandleValidSubmit()
	{
		apiError = null;

		try
		{
			if (isEditing)
			{
				var response = await Http.PutAsJsonAsync($"api/subject", currentSubject);

				if (!response.IsSuccessStatusCode)
				{
					apiError = $"Greška prilikom uređivanja kolegija: {response.ReasonPhrase}";
					return;
				}

				isEditing = false;

				var index = Array.FindIndex(subjects, student => student.Id == currentSubject.Id);

				if (index >= 0)
				{
					subjects[index] = currentSubject;
				}
			}
			else
			{
				var response = await Http.PostAsJsonAsync("api/subject", currentSubject);

				if (!response.IsSuccessStatusCode)
				{
					apiError = $"Greška prilikom dodavanja kolegija: {await response.Content.ReadAsStringAsync()}";
					return;
				}

				await LoadSubjects();
			}

			currentSubject = new Subject();
		}
		catch (Exception ex)
		{
			apiError = $"Došlo je do pogreške: {ex.Message}";
		}
	}

	private void EditSubject(Subject subject)
	{
		isEditing = true;
		apiError = null;
		currentSubject = subject;
	}

	private async Task DeleteSubject(Subject subject)
	{
		apiError = null;

		try
		{
			var response = await Http.DeleteAsync($"api/subject/{subject.Id}");

			if (!response.IsSuccessStatusCode)
			{
				apiError = $"Greška prilikom brisanja kolegija: {response.ReasonPhrase}";
				return;
			}

			await LoadSubjects();
		}
		catch (Exception ex)
		{
			apiError = $"Došlo je do pogreške pri brisanju: {ex.Message}";
		}
	}

	private void CancelEdit()
	{
		isEditing = false;
		currentSubject = new Subject();
		apiError = null;
	}
}
